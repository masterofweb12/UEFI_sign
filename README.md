# Ubuntu 22.04 исполнение только подписанного кода


## Зададимся задачей исполнять на целевой системе только подписаный ( доверенный ) код.

Во исполнение этой задачи нам необходим обеспечить следующее:
1) безопасную загрузку доверенного подписанного кода ядра Linux
2) загрузку исключительно подписанных драйверов ( модулей ядра Linux )
3) доверенную инициализацию пользовательского пространства ( процесс init )
4) исполнение только подписанных бинарных файлов

### Безопасная загрузка доверенного подписанного кода ядра Linux

 Если *ядро Linux* скомпилировано с параметром *CONFIG_EFI_STUB* ( а в ubuntu это именно так ), то оно поддерживает загрузку напрямую из *UEFI*.
Таким образом мы можем перенести *ядро* в *ESP* ( *EFI System Partition* ) располженный обычно в */boot/efi*, настроить UEFI таким образом, чтоб *ядро* грузилось напрямую, и всё должно работать.
 Однако это не будет полноценным решением, потому как *ядру* надо передать в качестве параметра образ *initramfs*, целостность которого мы никоим образом не можем проверить, что влечёт за собой возможность подмены образа *initramfs* с последующей компроментацией всей системы.
 Во избежание изложенного выше мы должны объединить *ядро* и образ *initramfs* в единый испонимый файл и запускать напрямую его. К счастью такая возможность существует. 
 
 Прежде чем подписывать код ядра, мы должны сгенерировать ключи, которыми мы будем подписывать ядро и всё остальное. Для этого нам понадобится скрипт
 [UEFI/MOK_KEYS/make_keys.sh](/UEFI/MOK_KEYS/make_keys.sh).

 Этот скрипт запросит имя ключа ( оно же будет выступать в качестве Common Name сертификата ).
Запустим скрипт и для примера назовём наш ключ **masterkey**. Скрипт сгенерирует следующие файлы и каталоги:  
keys  
masterkey.GUID.txt  
masterkey.cer  
masterkey.cer.siglist  
masterkey.crt  
masterkey.key

В файлах *masterkey.crt* и *masterkey.key* содержатся сертификат и его приватный ключ. В файле *masterkey.cer* тот же сертификат в формате *DER*.
Также скрипт генерирует произвольный *UUID* и сохраняет его в файл *masterkey.GUID.txt*.
На основе файлов *masterkey.GUID.txt* и *masterkey.cer* генерируется *siglist*.  
**siglist** является специальным видом файла экспорт которого возможен в энергонезависимую памят *UEFI*.  
В каталоге *keys* будут созданы следующие подкаталоги:  
KEK  
PK  
db  
dbx  
Назначение этих подкаталогов следующее: 
    Platform Key (PK) — публичный ключ владельца платформы. Подписи соответствующим приватным ключом необходимы для смены PK или изменения KEK, db и dbx (описаны далее). Хранилище PK должно быть защищено от вмешательства и удаления.  
    Key Exchange Key (KEK) — публичные ключи операционных систем. Подписи соответствующими приватными ключами необходимы для изменения баз данных подписей (db, dbx, описаны далее). Хранилище KEK должно быть защищено от вмешательства.  
    Базы данных подписей (db, dbx) — Базы данных подписей и хешей доверенных приложений (db) и недоверенных приложений (dbx).  








Для того, чтоб отработали строки ниже с вызовами keyctl,
необходимо сделать следующую штуку - объеденить сессионную 
и пользовательскую цепочку ключей.
`
keyctl link @us @s
`


Далее можем создавать ключи
`
EVM encrypted key is used for EVM HMAC calculation:

    # create and save the key kernel master key (user type)
    # LMK is used to encrypt encrypted keys
    keyctl add user kmk "`dd if=/dev/urandom bs=1 count=32 2>/dev/null`" @u
    keyctl pipe `keyctl search @u user kmk` > /etc/keys/kmk

    # create the EVM encrypted key
    keyctl add encrypted evm-key "new user:kmk 64" @u
    keyctl pipe `keyctl search @u encrypted evm-key` >/etc/keys/evm-key
`
